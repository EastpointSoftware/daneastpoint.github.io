var dbconn = require("../");
var mongo = require("mongodb");
var BSON = mongo.BSONPure;  

var collectionName = "popcmspages";

exports.getByPermalink= function (permalink, connString, dbCollectionNamePrefix, callback) {  
    dbconn.getDb(connString, function(err, db){ 
		if(err)
		{
			return callback(err);
		} 
		db.collection(dbCollectionNamePrefix + collectionName).findOne({"permalink": permalink }, function (err, data) { 
			if (err) { 
				return callback(err); 
			} 
			else
			{ 
				return callback(null, data);
			}
		});
	}); 
};

exports.upsertPermalink = function(data, connString, dbCollectionNamePrefix, callback){
	
    console.log("upsertPermalink");
    if(callback === null || typeof(callback) !== "function")
	{
		throw "Call to db method must include callback function";
	}
	
	dbconn.getDb(connString, function(err, db){ 
		if(err)
		{
			return callback(err);
		}  
		db.collection(dbCollectionNamePrefix + collectionName).update(
		{
			"permalink" : data.permalink
		}
		,data, {"upsert" : true, "new" : true}, function(err, n)
		{  
			if(err){    
				console.log("Error:" + err);
				callback(err);
			}
			else{
				db.collection(dbCollectionNamePrefix + collectionName+"Versions").update(
				{
					"permalink" : data.permalink
				}, 
				{
					$push  : {"Versions"  :  data } 
				}, 
				{
					"upsert" : true
				}, 
				function(err){ 
				}); 
				callback(null, n);
			}
		});
	});
}; 


