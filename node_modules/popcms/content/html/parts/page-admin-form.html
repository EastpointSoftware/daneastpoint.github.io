<style>
	@import "//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.css";
</style>
<style>
	.cke_editable {
		min-height: 200px;
		border:1px dashed #999;
	}
	#adminPanel{ 
		position: fixed;
		top: 0;
		right: 0;
		background-color: #363636;
		padding: 5px 5px 10px 10px;
		border-bottom-left-radius: 5px;
		height: auto; 
		z-index: 9998;
	}
	
	#adminPanel a{ 
		margin: 5px;
	}
	body{
		padding-right: 60px;
	}
	#pageSettings{
		position: fixed;
		top: 0;
		background-color: #363636;
		padding: 5px;
		height: auto;
		width:100%;
		z-index: 999;
	}
	#pageSettings label,
	#pageSettings p{
		display:block;
		color: #fff;
	} 
	#pageSettings input{
		max-width: 100%;
	}
</style>
<div id="adminPanel">
	<a href="/logout/" class="btn btn-danger" title="Logout"><i class="glyphicon glyphicon-log-out" alt="Logout" ></i></a><br />
	<a href="#" class="btn btn-primary" title="Edit Page Settings" id="btnShowEdit"><i class="glyphicon glyphicon-pencil" alt="Edit"></i></a><br />
	<a href="#" title="Save Changes" class="btn btn-primary"  id="btnSaveChanges"><i class="glyphicon glyphicon-floppy-disk" ></i></a><br />
</div>
<form id="pageSettings" style="display:none">
		<div class="row"> 
			<div class="col-sm-2"> 
				<label for="pageTemplate">template:</label> 
				<select id="pageTemplate" name="pageTemplate" required="true">   
					{{#select template}}
					<!--<option value="">Template</option> -->
					{{#each templateList}}
					<option value="{{name}}">{{name}}</option>
					{{/each}}
					{{/select}}  
				</select> 
			</div>
			<div class="col-sm-2"> 
				<label for="pageTitle">title <span id="pageTitleCount"></span>:</label>
				<input type="text" name="pageTitle" id="pageTitle" value="{{title}}" placeholder="Page title" />
			</div>
			<div class="col-sm-2"> 
				<label for="pageKeywords">keywords <span id="pageKeywordsCount"></span>:</label>
				<input type="text" name="pageKeywords" id="pageKeywords" value="{{keywords}}" placeholder="Page keywords" />
			</div>
			<div class="col-sm-3"> 
				<label for="pageDescription">description <span id="pageDescriptionCount"></span>:</label>
				<input type="text" name="pageDescription" id="pageDescription" value="{{description}}" placeholder="Page description" />
			</div> 
			<div class="col-sm-1"><br />/div>
		</div>
	</form> 
<script>
(function(){
	var changeCount = 0;

	var getCKEDITOR = function()
	{
		var ckEditorSourceUrl = "//cdn.ckeditor.com/4.6.1/standard/ckeditor.js";
		//var ckEditorSourceUrl = "//cdnjs.cloudflare.com/ajax/libs/ckeditor/4.3.2/ckeditor.js";
		
		getScript(ckEditorSourceUrl, function() {
			if (typeof CKEDITOR==='undefined') { 
				alert('Unable to load Text Editor from Server. Please try again later.'); 
			} else {
				// get toastr (for notifications)
				getScript("//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.js", function(){
					try{
					toastr.options = {
					"closeButton": true,
					"debug": false,
					"newestOnTop": true,
					"progressBar": false,
					"positionClass": "toast-top-right",
					"preventDuplicates": true,
					"onclick": null,
					"showDuration": "300",
					"hideDuration": "1000",
					"timeOut": "5000",
					"extendedTimeOut": "1000",
					"showEasing": "swing",
					"hideEasing": "linear",
					"showMethod": "fadeIn",
					"hideMethod": "fadeOut"
					}
					}
					catch (e){

					}
					formLoad(); 
				})
			}
		});
	};
		
	function getScript(url, success) {

		var script     = document.createElement('script');
				script.src = url;
		
		var head = document.getElementsByTagName('head')[0],
		done = false;
		
		// Attach handlers for all browsers
		script.onload = script.onreadystatechange = function() {
		
			if (!done && (!this.readyState || this.readyState === 'loaded' || this.readyState === 'complete')) {
			
			done = true;
				
				// callback function provided as param
				success();
				
				script.onload = script.onreadystatechange = null;
				head.removeChild(script);
				
			};
		
		};
		
		head.appendChild(script);

	};

	if (typeof jQuery === 'undefined') {
	
		getScript('//code.jquery.com/jquery.min.js', function() {
		
			if (typeof jQuery==='undefined') { 
				alert('Unable to load jQuery');
			
			} else {
				getCKEDITOR();
			}
		
		});
		
	} else { // jQuery was already loaded
		getCKEDITOR();

	};

	function reloadPage(){
		changeCount=0;
		toastr["success"]("Please note that template and meta details require a page refresh to see.", "Your changes have been saved.");
		// window.location.reload(true);
	}
	 
	function calcTotals(){
			$("#pageTitleCount").html(" (<b>" + $("#pageTitle").val().length + "</b>/70)");
			$("#pageKeywordsCount").html(" (<b>" + $("#pageKeywords").val().length + "</b>)");
			$("#pageDescriptionCount").html("<b> (" + $("#pageDescription").val().length + "</b>/150-160)");
	}

	function InstanceReadyEvent() {

		this.document.on("keyup", function () {
		   changeCount += 1;
		   calcTotals();
		});
	}

	var formLoad = function(){
        // This property tells CKEditor to not activate every element with contenteditable=true element.
         CKEDITOR.disableAutoInline = true;
          
        changeCount = 0;
        window.onbeforeunload = function() {
            if(changeCount>0)
            {
                return "You didn't save your changes!";
            }
        }; 
        
		var tooglePageSettingsStateVisible = false;
		$("#btnShowEdit").click(function(event){
			event.preventDefault();
			//$("#adminPanel").slideUp(100);
			if(tooglePageSettingsStateVisible){
				$("#pageSettings").slideUp(200);
			}
			else{
				$("#pageSettings").slideDown(200);
			}
			tooglePageSettingsStateVisible = !tooglePageSettingsStateVisible;
		});

		$("#btnSaveChanges").click(function(event){
			event.preventDefault();
			$("#pageSettings").trigger("submit");
		})

        $("#pageSettings").submit(function(event){ 
			event.preventDefault();
			console.log("saving....");
            var template = $("#pageTemplate").val();
            var data = {
                "permalink":"{{permalink}}",
                "template":template,
                "title":$("#pageSettings #pageTitle").val(),
                "keywords":$("#pageSettings #pageKeywords").val(),
                "description":$("#pageSettings #pageDescription").val(),
                "body":{}
            };

            try
            {

				for(var i in CKEDITOR.instances) { 
					data.body[CKEDITOR.instances[i].name] = CKEDITOR.instances[i].getData(); 
				}   
			}
			catch(e)
			{
				alert(e);
			} 

			//alert(JSON.stringify(data));
            //return false;
            
            $.ajax({
                type: "POST",
                url: "/api/pages/",
                data: data,
                complete: reloadPage,
                dataType: "application/json"
            });  
            return false;
        });  
            
		$("div[contenteditable='true']").each(function(idx, obj)
		{   
			//alert(obj.id);
			CKEDITOR.inline(obj.id,
			  { 
				 //customConfig: '/js/ckeditor.js' 
			  }); 
			CKEDITOR.instances[obj.id].on("instanceReady", InstanceReadyEvent);
		});

        calcTotals();
	}})();
    </script>   