var handlebars = require('handlebars'); 
var handlebarsHelpers = require('./handlebarsHelpers.js'); 
var fs = require('fs'); 
var pages = require('../db/pages/');
var navigation = require('../db/navigation/'); 
var nav = null;
var templatePath = __dirname + '/../html';

var config;
module.exports = function attachHandlers (router) { 
    // get requests 
    router.get('*', getPage); 
	config = router.config; 
	templatePath = config.templatePath;
	
	navigation.getFullNav(config, function(err, data){
		if(err){console.log(err)}
		//console.log('got nav:' + data);
		nav=data;
	});

};
  

handlebarsHelpers.register(handlebars);
 
var cache = {}; 

var getPageFromCache = function(url, callback) {   
    if (cache[url]) { 
        return callback(undefined, cache[url]);
    } else { 
        return callback();
    }
}; 

var setPageToCache= function(url, content) {
    cache[url] = content;
};

var removePageFromCache= function(url) { 
    cache[url] = null;
};
 
function implementTemplate(req, pageData, callback) {
	
    var body, source;
	if(pageData===null) {pageData = {};}
	if(pageData.template === null || typeof(pageData.template) === "undefined")
	{
		pageData.permalink = req.url;
		if(pageData.admin){ 
			source = "This page doesn't exist, but as you are the site admin, you can create it using the page admin form!";		
		}
		else{
			pageData.template="404.html";
		}
	}
 
	try
	{
		body = fs.readFileSync(templatePath + '/master.html', 'utf8'); 
	}
	catch(e)
	{
		body="Please add your master page at '" + templatePath + "/master.html'";
	}
	
	if(source == null)
		{
		try
		{
			source= fs.readFileSync(templatePath + '/' + pageData.template + '', 'utf8'); 
		}
		catch(e)
		{
			source="Please add your selected template file to '" + templatePath + "/" + pageData.template + "'";
		};
	}

	body = body.replace("[[[body]]]", source);
	
	var myRegexp = /\[\[\[editable:([a-zA-Z-0-9]+)\]\]\]/g;
	match = myRegexp.exec(body);
	console.log(match);
	while (match != null) {
		// matched text: match[0]
		// match start: match.index
		// capturing group n: match[n]
		var matchText = match[0]; 
		var matchTextVarName = match[1]; 
		
		body = body.replace(matchText, "<div id=\"" + matchTextVarName + "\" contenteditable=\"{{contentEditable}}\">{{{body." + matchTextVarName + "}}}</div>");
		console.log("Replaced " + matchText);
		match = myRegexp.exec(body);
		
	}

	// add standard contact form
	try
	{
		if(body.indexOf("[[[contactform]]]") > 0){ 
			source= fs.readFileSync(__dirname + '/html/parts/contact-form.html', 'utf8'); 
			body = body.replace("[[[contactform]]]", source);
		}
	}
	catch(e)
	{
		alert(e);
	};
	
	pageData.navigation = nav;
	
	//console.log("Data : " + JSON.stringify(pageData));
	
	if(pageData.admin){
		var adminHtml = fs.readFileSync(__dirname + '/html/parts/page-admin-form.html', 'utf8'); 
		body = body.replace("</body>", adminHtml + "</body>");
		
		// get list of templates
		var files = fs.readdirSync(templatePath);
		// will eventually be a bit more delicate with this, for instance filting based on filename or extension.
		pageData.templateList = []; 
		files.forEach(function(entry) {
			if(entry!=="master.html" && entry != "404.html")
			{
				pageData.templateList.push({"name" : entry}); 
			}
			
		});
	}else{
		body = body.replace(matchText, "contenteditable=\"{{contentEditable}}\"", "");
	}
	
    var template = handlebars.compile(body.replace("[[[body]]]", source)); 
    var result = template(pageData);  

    return callback(null, result);
}

function getPageFromDb(req, callback){
 
    try{   
        pages.getByPermalink(req.url, config.connString, config.dbCollectionNamePrefix,  function (err, data) 
		{  
			if(err){return callback(err);}
			
			if(data ===null && req.url==="/login"){
				return callback(null, "<html><title>Login</title><body>If you wish. you can create a new login.html file in your templates folder. In the meantime, <a href='/auth/google'>Login via Google</a>.</body></html>");
			}
			
			if(data===null){ 
				data = {title:"Page not found"}
			}
			
			data.permalink = req.url;
			dmin = false;
			data.contentEditable = "false";
			
			if(req.user)
			{
				data.admin = true;
				data.contentEditable = "true";
			}

			implementTemplate(req, data, function(err, htmlContent){
				if(err){return callback(err);}
				return callback(null, htmlContent);
			});
		}); 
	}
    catch(e)
    {
		return callback(e); 
    }
 }
 

setConfig = function(settings){
	templatePath = settings.templatePath;
};

getPage =function(req, res) { 
	getPageFromDb(req, function (err, htmlContent)
	{
		if(err){console.log(err);
			return res.send(500);}
		return res.send(htmlContent);
	});

};